---
title: "Core Microbiome"
date: "`r Sys.Date()`"
runtime: shiny
output: 
  html_document:
    fig_width: 16
    fig_height: 10
    fig_caption: true
    number_sections: true
    toc: false
    toc_float:
      collapsed: false
---

```{r setup, include=FALSE}
rm(list=ls())

knitr::opts_chunk$set(echo = TRUE)

# For testing
devtools::load_all("..")

# For production
# library(EcologyCore)
```

```{r params, include=FALSE}
#### Parameters ####
biom_path="/Users/reuben/test_data/data/Batch 1/asv_even_taxon.biom"
meta_path="/Users/reuben/test_data/data/metadata.csv"
tree_path="/Users/reuben/test_data/data/Batch 1/tree_rooted.nwk"
grouping_column<-"Groups"
```

```{r import_data, include=FALSE}
#### Data Import ####

result <- import_data(biom_path, meta_path, tree_path)

abund_table <- result[[1]]
taxa_table <- result[[2]]
meta_table <- result[[3]]
taxa_tree <- result[[4]]

rm(result)
```

# Core Microbiome

The core microbiome captures the set of microbial taxa consistently found across a given group of samples.

## Abundance

```{r core_hypothesis, include=TRUE}
#### Hypothesis ####

# Hypothesis 1
label="Abstraction_Method"

meta_table$Groups <- as.factor(as.character(paste("Run ", meta_table$run)))

meta_table$Type <- NULL
meta_table$Type2 <- NULL
meta_table$Connections <- NULL
```

```{r ref.label='collate', include=FALSE}
```

```{r core_microbiome, echo=FALSE}
# Loop through and create a core plot for each unique group
plots <- list()
for (group in unique(meta_table$Groups)) {
  meta_sub <- meta_table[meta_table$Groups == group,]
  
  data <- core_microbiome(abund_table, meta_sub, taxa_table, taxa_tree, what_detection = "absolute", short_names = TRUE)
  
  plots <- append(plots, list(data))
}

print(do.call(gridExtra::grid.arrange, plots))
```

## Taxa Bars

```{r core_taxa, echo=FALSE}
data <- core_taxa(abund_table, meta_table, taxa_table, taxa_tree)
plot <- plot_core_taxa(data)

print(plot)
```

## Abundance-Occupancy Models

## Hypothesis Setting

## Plots
